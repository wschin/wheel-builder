env:
  global:
    - REPO_DIR=onnx
    - BUILD_COMMIT=553df22c67bee5f0fe6599cff60f1afc6748c635
    - PLAT=x86_64
    - PB_VERSION=2.6.1
    - UNICODE_WIDTH=32
    - REPO=https://upload.pypi.org/legacy/
    - TEST_REPO=https://test.pypi.org/legacy/
    - secure: pUB9yT5QOqYTywGE5rFIpwe/TdVG0jmsoEswg62sVy9Qc9Isyus36cMLM9gCxcWKhPr6V9qQ6yGNaQ2GkSM8HYodYV94nnGdP6Ou9MOG+csjKu03a8P8F2hQdcO6r0kKzUlTuQxoQHeX+DjIeRVWcLHok7S39eC679n6aD+0eyq9XfjWGnKusLRp7+TsFzEWKFMrZBUcKIuYR4z+FN8P5v9Se2BH3ufvRmf5IGhW0FU5eBfBAdGrxsjX3iP/tvN8McC0fXhYyZJof0wl6u/Nw3A1kbbUxFuTCEnfbKyl712QocaNr/MBzoctBal0cELxwhgbFwQt4fCxvS1XA2TqSkJZL3T+tZhyTtitiORoXudMZUw13kvGEOHNkkN/u7Ib6HzaNV9UTFCrgewdjz8mfurG/MywFOa6WNHts6JRhRPJez6yhJDTZdpUiCpjMLJX8/IhrN4GLN83AJgVoVaqoFIbdSyOOKMmnZ9CSuMh9bmUxCCY52cC2yqIWJFOtENw2KQw0sx0ftdCNVqnGGpE4PgHTlEYDDwePZh9N+upbVQSug4MuDZE/PZ9DepBZFT7yAPwm0Uwapsy8X9f03i9858fzFlfPenU9KSFgXKqHyYUqjEXTIkRiFUsbUhbZdj99nZtGGeVB8u1+KWQWsyrOiVwzyF3w+vyKSFhKCxQcS8=
    - secure: KgEoqN1Zy/2uIF9GJ6zwdPRM/RrKu5AvLxPp2KN2HAw9synJYKQZCJt5RKrCoLGt+dePW5QhYCzxxVGR/9NQPPHY3qVrdDvZz9R2Bajix2HzNNnE3qR9h8IRUREvW/GTyDbz3+YQ051omlmrYknSacY0by3Ixy5Asw5QK75s92tPi+hKyPW7g4QkEgxDPUexs4tAzQAESotiNvkPjaLKWThmTlLzEK9mnnGznROQzb43nEfJ4QcV1DyTYQc7xqb0PcyGk8lAXUG5gC4s5KPTkTuuRf/xiUNNFzXSCZzLO3WmskOfibH3gXteX6PVd30NYvcgpmz9M7l0ZXL9D+yqVQJ1T9yPX7cFpFpGCJHsxxcxJ6lp6I2FIp5fSJJBeU8pUqNMjWo40Psb8k52aXMB/Ua/B17Dp/mEtuLedMxFuXIQ2CA5mIadpUa+iGmW9SrFSAN917Un327pRAJytBB1HLtuOgdkXgwGRDWS3LGIxGersRw3dtBDvWBbt2CeCifMITgqgaDC2WOQLdREP/derGjOniZB3TKhBXjpWtCtsuKWu6PtJr0RugHwNfXOJY5xghQxxiDvWm+78m6vSBpbX4Fwc1D8WlKNX8jXci27zwjt/IvrNFtHE+BxsdRLoj7g4xcCkD5C1EXx0sfe4q4P4pqoX0PpNqPfQdh5pYy7aaQ=
language: python
# Default Python version is usually 2.7
python: 3.5
sudo: required
dist: trusty
services: docker
# Force xcode 6.4 image to work round
# https://github.com/python-pillow/pillow-wheels/issues/45
# So we have the line below for OSX builds
# osx_image: xcode9.3beta
matrix:
  # Exclude the default Python 3.5 build
  exclude:
  - python: 3.5
  include:
  - os: osx
    language: generic
    sudo: required
    osx_image: xcode9.3beta
    env:
      - MB_PYTHON_VERSION=3.5
      - ONNX_ML=1
      - MACOSX_DEPLOYMENT_TARGET=10.9
  - os: osx
    language: generic
    sudo: required
    osx_image: xcode9.3beta
    env:
      - MB_PYTHON_VERSION=3.6
      - ONNX_ML=1
      - MACOSX_DEPLOYMENT_TARGET=10.9
  - os: osx
    language: generic
    sudo: required
    osx_image: xcode9.3beta
    env:
      - MB_PYTHON_VERSION=3.7
      - ONNX_ML=1
      - MACOSX_DEPLOYMENT_TARGET=10.9
  - os: osx
    language: generic
    sudo: required
    osx_image: xcode9.3beta
    env:
      - MB_PYTHON_VERSION=2.7
      - ONNX_ML=1
      - MACOSX_DEPLOYMENT_TARGET=10.9
  - os: linux 
    sudo: required 
    env: 
      - MB_PYTHON_VERSION=2.7 
      - ONNX_ML=1 
  - os: linux 
    sudo: required 
    env: 
      - MB_PYTHON_VERSION=2.7 
      - ONNX_ML=1 
      - UNICODE_WIDTH=16 
  - os: linux 
    sudo: required 
    env: 
      - MB_PYTHON_VERSION=2.7 
      - ONNX_ML=1 
      - PLAT=i686 
  - os: linux 
    sudo: required 
    env: 
      - MB_PYTHON_VERSION=2.7 
      - ONNX_ML=1 
      - UNICODE_WIDTH=16 
      - PLAT=i686 
  - os: linux 
    sudo: required 
    env: 
      - MB_PYTHON_VERSION=3.5 
      - ONNX_ML=1 
  - os: linux 
    sudo: required 
    env: 
      - MB_PYTHON_VERSION=3.6 
      - ONNX_ML=1 
  - os: linux 
    sudo: required 
    env: 
      - MB_PYTHON_VERSION=3.7 
      - ONNX_ML=1 
  - os: linux 
    sudo: required 
    env: 
      - MB_PYTHON_VERSION=3.5 
      - ONNX_ML=1 
      - PLAT=i686 
  - os: linux 
    sudo: required 
    env: 
      - MB_PYTHON_VERSION=3.6 
      - ONNX_ML=1 
      - PLAT=i686
  - os: linux 
    sudo: required 
    env: 
      - MB_PYTHON_VERSION=3.7 
      - ONNX_ML=1 
      - PLAT=i686

before_install:
  - source multibuild/common_utils.sh;
  - source multibuild/travis_steps.sh;
  - before_install;

install:
  - clean_code $REPO_DIR $BUILD_COMMIT;
  - build_wheel $REPO_DIR $PLAT;

script:
  - install_run $PLAT

after_success:
- >
  if [ -n "$TRAVIS_TAG" ]; then
    pip install twine;
    pip install pyOpenSSL ndg-httpsclient pyasn1 || true;
    python -m twine upload --skip-existing ${TRAVIS_BUILD_DIR}/wheelhouse/*.whl --repository-url $REPO -u $PYPI_USERNAME_TRAVIS -p $PYPI_PASSWORD_TRAVIS ;
    echo "Deployed to PyPI.";
  else
    echo "Not deploying as not a tagged commit.";
  fi
- >
  if [ "$TRAVIS_BRANCH" == "pypi_test" ]; then
    pip install twine;
    pip install pyOpenSSL ndg-httpsclient pyasn1 || true;
    ls ${TRAVIS_BUILD_DIR}/wheelhouse/;
    python -m twine upload --skip-existing ${TRAVIS_BUILD_DIR}/wheelhouse/*.whl --repository-url $TEST_REPO -u $PYPI_USERNAME -p $PYPI_PASSWORD ;
    echo "Deployed to test PyPI.";
  else
    echo "Not deploying as not a commit on test branch.";
  fi

cache:
- timeout: 300
- directories:
  - "$BUILD_CCACHE_DIR"
  - "$HOME/.ccache"
  - "$HOME/.cache/pb"
